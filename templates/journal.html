<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDVita - Journal</title>
  <link rel="stylesheet" href="/static/base.css">
</head>
<body>
  <div class="container">
    <div id="api-alert" style="display:none; padding:10px; background:#ffcccc; color:#900; border-radius:5px; margin-bottom:10px;">
      ⚠️ API is currently down. Showing fallback results.
    </div>

    <h2 id="greeting">Your Journal</h2>
    <textarea id="journal-text" placeholder="Write your thoughts here..." rows="6"></textarea>

    <div class="journal-buttons">
      <button onclick="saveEntry(false)">Save</button>
      <button onclick="saveEntry(true)">Analyze & Save</button>
    </div>

    <div id="analysis-result" class="analysis-card"></div>

    <h3>Recent Entries</h3>
    <div id="recent-entries" class="entries-list"></div>

    <button onclick="logout()" class="logout-btn">Logout</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, doc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCnowHleZxXSH3bK34Bb1ZOgUNe5T28Gsg",
      authDomain: "mdvita-229be.firebaseapp.com",
      projectId: "mdvita-229be",
      storageBucket: "mdvita-229be.appspot.com",
      messagingSenderId: "417004792942",
      appId: "1:417004792942:web:fe89b380020f15318fca7f",
      measurementId: "G-NT5P07MJHX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const greeting = document.getElementById("greeting");
    const entriesDiv = document.getElementById("recent-entries");
    const analysisDiv = document.getElementById("analysis-result");
    const apiAlert = document.getElementById("api-alert");

    let currentUser = null;
    let editingEntryId = null;

    onAuthStateChanged(auth, user => {
      if(user){ 
        currentUser = user; 
        greeting.innerText = `Welcome, ${user.displayName || user.email}!`; 
        loadRecentEntries(); 
      }
      else window.location.href="/"; // Redirect to Flask login
    });

    window.logout = ()=> signOut(auth).then(()=>window.location.href="/");

    window.saveEntry = async(doAnalyze)=>{
      const text = document.getElementById("journal-text").value.trim();
      if(!text) return alert("Write something first!");
      const wordCount = text.split(/\s+/).length;
      const timestamp = new Date().toISOString();
      let sentiment = null;

      if(doAnalyze){
        try{
          const res = await fetch("/analyze",{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({text})});
          const data = await res.json();
          apiAlert.style.display = data.api_down ? "block" : "none";

          if(data.success && data.sentiment){
            sentiment = data.sentiment;
            const s = sentiment;
            analysisDiv.innerHTML=`
              <p><strong>Mood:</strong> ${s.emoji} ${s.mood}</p>
              <p><strong>Score:</strong> ${s.score}/5</p>
              <p>${s.message}</p>
              <ul>${s.suggestions.map(g=>`<li>${g}</li>`).join('')}</ul>
            `;
          } else { analysisDiv.innerHTML=`<p style="color:red;">Analysis failed</p>`; }
        }catch(e){ analysisDiv.innerHTML=`<p style="color:red;">Error: ${e.message}</p>`; }
      }

      if(editingEntryId){
        await updateDoc(doc(db,"entries",editingEntryId),{ text, wordCount, sentiment, date:timestamp });
        editingEntryId = null;
      } else {
        await addDoc(collection(db,"entries"),{ user:currentUser.uid, text, wordCount, sentiment, date:timestamp });
      }

      document.getElementById("journal-text").value="";
      loadRecentEntries();
    };

    async function loadRecentEntries(){
      entriesDiv.innerHTML="";
      const q=query(collection(db,"entries"), orderBy("date","desc"));
      const snapshot = await getDocs(q);
      snapshot.forEach(docSnap=>{
        const e = docSnap.data();
        if(e.user===currentUser.uid){
          const shortText = e.text.length>50 ? e.text.substring(0,50)+"..." : e.text;
          const entryDiv = document.createElement("div");
          entryDiv.className = "entry-card";
          entryDiv.innerHTML = `
            <p><strong>${new Date(e.date).toLocaleString()}</strong> (${e.wordCount} words)</p>
            <p>${shortText}</p>
            ${e.sentiment ? `<p>${e.sentiment.emoji} ${e.sentiment.mood} - ${e.sentiment.message}</p>` : ""}
          `;
          entryDiv.style.cursor = "pointer";
          entryDiv.title = "Click to edit this entry";
          entryDiv.onclick = ()=>{
            document.getElementById("journal-text").value = e.text;
            editingEntryId = docSnap.id;
            analysisDiv.innerHTML = e.sentiment ? `
              <p><strong>Mood:</strong> ${e.sentiment.emoji} ${e.sentiment.mood}</p>
              <p><strong>Score:</strong> ${e.sentiment.score}/5</p>
              <p>${e.sentiment.message}</p>
              <ul>${e.sentiment.suggestions.map(g=>`<li>${g}</li>`).join('')}</ul>
            ` : "";
          };
          entriesDiv.appendChild(entryDiv);
        }
      });
    }
  </script>
</body>
</html>
