<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDVita - Discover</title>
  <link rel="stylesheet" href="/static/dashboard.css">
  <style>
    .video-card { margin: 10px; display: inline-block; vertical-align: top; text-align: center; }
    .video-card p { max-width: 350px; color: #444; font-weight: 600; margin-top: 5px; }
    .video-card.fallback { 
      background: #ffe0e0; padding: 20px; border-radius: 12px; color: #900; font-weight: bold; 
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .video-card.fallback img { max-width: 150px; margin-bottom: 10px; }
    .news-card { background: #e0f7f1; padding: 12px; border-radius: 12px; margin: 10px 0; }
    .news-card h3 { margin: 0 0 5px; color: #00b38f; }
    .news-card p { margin: 0 0 5px; }
    .news-card a { color: #00796b; text-decoration: none; }
    .news-card a:hover { text-decoration: underline; }
    .discover-search { margin-bottom: 15px; }
    #search-query { width: 250px; padding: 6px; border-radius: 6px; border: 1px solid #ccc; }
    #search-btn { padding: 6px 10px; border-radius: 6px; border: none; background: #00b38f; color: #fff; cursor: pointer; margin-left: 5px; }
    #search-btn:hover { background: #009377; }
  </style>
</head>
<body>
  <div class="dashboard-bg">
    <div class="dashboard-container">

      <!-- Header -->
      <div class="dashboard-header">
        <div class="logo-container">
          <img src="/static/images/logo.png" alt="MDVita Logo" class="logo">
          <h1>MDVita</h1>
        </div>
        <div class="profile-container">
          <img id="profile-pic" src="/static/images/default-avatar.png" alt="Profile" class="profile-pic" onclick="goToProfile()">
          <span id="user-name-top">User</span>
        </div>
      </div>

      <h2>Discover Health & Wellness</h2>

      <!-- Search Bar -->
      <div class="discover-search">
        <input type="text" id="search-query" placeholder="Search health videos..." />
        <button id="search-btn">Search</button>
      </div>

      <!-- Videos Section -->
      <div id="videos-section" class="videos-section">
        <div class="video-card">
          <iframe width="350" height="200" src="https://www.youtube.com/embed/1ZYbU82GVz4" frameborder="0" allowfullscreen></iframe>
          <p>Healthy Eating Tips</p>
        </div>
        <div class="video-card">
          <iframe width="350" height="200" src="https://www.youtube.com/embed/2L2lnxIcNmo" frameborder="0" allowfullscreen></iframe>
          <p>Meditation for Beginners</p>
        </div>
        <div class="video-card">
          <iframe width="350" height="200" src="https://www.youtube.com/embed/3Uo0JAUWijM" frameborder="0" allowfullscreen></iframe>
          <p>10-Minute Full Body Workout</p>
        </div>
      </div>

      <!-- News Section -->
      <h2>Latest Health News</h2>
      <div id="news-section" class="news-section">
        <div class="news-card">
          <h3>10 Tips for a Healthy Heart</h3>
          <p>Regular exercise and balanced diet are key to heart health.</p>
          <a href="#">Read more</a>
        </div>
        <div class="news-card">
          <h3>Mental Health Awareness</h3>
          <p>Learn simple techniques to reduce stress and improve focus.</p>
          <a href="#">Read more</a>
        </div>
        <div class="news-card">
          <h3>Benefits of Yoga</h3>
          <p>Yoga helps improve flexibility, balance, and mental wellbeing.</p>
          <a href="#">Read more</a>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

    const configData = await fetch('/firebase-config')
      .then(res => res.json())
      .catch(err => { console.error("Failed to load config:", err); return {}; });

    const { firebaseConfig, youtubeApiKey } = configData;
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const profilePic = document.getElementById("profile-pic");
    const userNameTop = document.getElementById("user-name-top");

    onAuthStateChanged(auth, user => {
      if(user){
        userNameTop.innerText = user.displayName || user.email;
        if(user.photoURL) profilePic.src = user.photoURL;
      } else {
        window.location.href = "/";
      }
    });

    window.goToProfile = () => { window.location.href = "/profile"; }

    const searchInput = document.getElementById("search-query");
    const searchBtn = document.getElementById("search-btn");
    const videosSection = document.getElementById("videos-section");
    let searchTimeout;

    function showFallback(message="Connection lost or no results."){
      videosSection.innerHTML = "";
      const fallbackDiv = document.createElement("div");
      fallbackDiv.classList.add("video-card", "fallback");
      fallbackDiv.innerHTML = `<img src="/static/images/no-results.jpg" alt="No results"><p>${message}</p>`;
      videosSection.appendChild(fallbackDiv);
    }

    async function searchVideos(query){
      if(!query || !youtubeApiKey) return;
      videosSection.innerHTML = `<p>Loading videos...</p>`;
      try {
        const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&maxResults=6&key=${youtubeApiKey}`;
        const res = await fetch(url);
        if(!res.ok){ showFallback("YouTube API error"); return; }
        const data = await res.json();
        if(!data.items || data.items.length === 0){ showFallback("No videos found."); return; }

        videosSection.innerHTML = "";
        data.items.forEach(item => {
          const videoId = item.id.videoId;
          const title = item.snippet.title;
          const videoCard = document.createElement("div");
          videoCard.classList.add("video-card");
          videoCard.innerHTML = `<iframe width="350" height="200" src="https://www.youtube.com/embed/${videoId}" title="${title}" frameborder="0" allowfullscreen></iframe><p>${title}</p>`;
          videosSection.appendChild(videoCard);
        });
      } catch(err){
        console.error("Error fetching videos:", err);
        showFallback();
      }
    }

    searchBtn.addEventListener("click", () => searchVideos(searchInput.value.trim()));
    searchInput.addEventListener("input", () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => { searchVideos(searchInput.value.trim()); }, 800);
    });

  </script>
</body>
</html>
