<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDVita - Profile</title>
  <link rel="stylesheet" href="/static/profile.css">
</head>
<body>
  <div class="profile-bg">
    <div class="profile-container">

      <!-- Header -->
      <div class="profile-header">
        <h1>My Profile</h1>
        <div class="top-profile">
          <img id="profile-pic" src="/static/images/default-avatar.png" alt="Profile Picture">
          <input type="file" id="upload-pic" accept="image/*" title="Change Picture">
        </div>
      </div>

      <!-- Profile Info -->
      <div class="profile-card">
        <h2 id="user-name">Loading...</h2>
        <p id="user-email">Loading...</p>
      </div>

      <!-- Actions -->
      <div class="profile-actions">
        <input type="text" id="new-name" placeholder="Enter new display name">
        <button id="update-name-btn">Update Name</button>

        <input type="password" id="new-password" placeholder="Enter new password">
        <button id="update-pass-btn">Update Password</button>
      </div>

      <button class="logout-btn" id="logout-btn">Logout</button>

    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateProfile, updatePassword, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

    async function getFirebaseConfig(){
      const res = await fetch('/firebase-config');
      const data = await res.json();
      return data;
    }

    const firebaseConfig = await getFirebaseConfig();
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    const profilePic = document.getElementById("profile-pic");
    const uploadPic = document.getElementById("upload-pic");
    const userName = document.getElementById("user-name");
    const userEmail = document.getElementById("user-email");
    const updateNameBtn = document.getElementById("update-name-btn");
    const updatePassBtn = document.getElementById("update-pass-btn");
    const logoutBtn = document.getElementById("logout-btn");

    onAuthStateChanged(auth, user => {
      if(user){
        userName.textContent = user.displayName || "Anonymous User";
        userEmail.textContent = user.email;
        if(user.photoURL) profilePic.src = user.photoURL;
      } else {
        window.location.href = "/";
      }
    });

    uploadPic.addEventListener("change", async e => {
      const file = e.target.files[0];
      if(!file) return;
      const allowedTypes = ["image/jpeg", "image/png", "image/gif"];
      if(!allowedTypes.includes(file.type)){
        return alert("Upload JPG, PNG, or GIF images!");
      }
      const user = auth.currentUser;
      const ext = file.name.split('.').pop();
      const storageRef = ref(storage, `profile-pics/${user.uid}.${ext}`);
      try {
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        const urlWithCacheBuster = url + "?v=" + new Date().getTime();
        await updateProfile(user, { photoURL: urlWithCacheBuster });
        profilePic.src = urlWithCacheBuster;
        alert("Profile picture updated!");
      } catch(err){
        console.error(err);
        alert("Failed to upload profile picture.");
      }
    });

    updateNameBtn.addEventListener("click", async ()=>{
      const newName = document.getElementById("new-name").value;
      if(!newName) return alert("Enter a name!");
      try {
        await updateProfile(auth.currentUser, { displayName: newName });
        userName.textContent = newName;
        alert("Name updated!");
      } catch(err){
        console.error(err);
        alert("Failed to update name.");
      }
    });

    updatePassBtn.addEventListener("click", async ()=>{
      const newPass = document.getElementById("new-password").value;
      if(!newPass) return alert("Enter a new password!");
      try {
        await updatePassword(auth.currentUser, newPass);
        alert("Password updated!");
      } catch(err){
        console.error(err);
        alert("Failed to update password. You may need to re-login.");
      }
    });

    logoutBtn.addEventListener("click", ()=> signOut(auth).then(()=> window.location.href="/"));
  </script>
</body>
</html>
